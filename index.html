<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Monitoramento</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">    
    
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/png" href="favicon.png">
</head>
<body>

    <div id="toast-container"></div>

    <div class="page-container">
        <div id="header-placeholder"></div>

        <main class="main-content" style="flex-direction: column;">
            
            <div id="backbone-alert-container" style="display: none; width: 100%; margin-bottom: 20px;"></div>

            <div id="global-overview-container" style="margin-bottom: 20px; width: 100%;"></div>
            
            <div id="overview-grid" class="grid-container">
                </div>
        </main>
    </div>

    <div id="footer-placeholder"></div>

    <script src="layout.js"></script>
    <script src="notifications.js"></script>

    <script>
        const oltsConfig = [
            { id: 'HEL-1', sheetTab: 'HEL1', type: 'nokia' },
            { id: 'HEL-2', sheetTab: 'HEL2', type: 'nokia' },
            { id: 'PQA-1', sheetTab: 'PQA1', type: 'nokia' },
            { id: 'PSV-1', sheetTab: 'PSV1', type: 'nokia' },
            { id: 'MGP',   sheetTab: 'MGP',  type: 'nokia' },
            { id: 'LTXV-1', sheetTab: 'LTXV1', type: 'furukawa-10' }, 
            { id: 'LTXV-2', sheetTab: 'LTXV2', type: 'furukawa-2' },
            { id: 'PQA-2',  sheetTab: 'PQA2',  type: 'furukawa-2' },
            { id: 'PQA-3',  sheetTab: 'PQA3',  type: 'furukawa-2' },
            { id: 'SB-1',   sheetTab: 'SB1',   type: 'furukawa-2' },
            { id: 'SB-2',   sheetTab: 'SB2',   type: 'furukawa-2' },
            { id: 'SB-3',   sheetTab: 'SB3',   type: 'furukawa-2' },
            { id: 'PSV-7',  sheetTab: 'PSV7',  type: 'furukawa-2' },
            { id: 'SBO-1',  sheetTab: 'SBO1',  type: 'furukawa-10' },
            { id: 'SBO-2',  sheetTab: 'SBO2',  type: 'furukawa-2' },
            { id: 'SBO-3',  sheetTab: 'SBO3',  type: 'furukawa-2' },
            { id: 'SBO-4',  sheetTab: 'SBO4',  type: 'furukawa-2' },
        ];

        const API_KEY = 'AIzaSyA88uPhiRhU3JZwKYjA5B1rX7ndXpfka0I';
        const SHEET_ID = '1BDx0zd0UGzOr2qqg1nftfe5WLUMh6MkcFO5psAG5GtU';
        const REFRESH_INTERVAL_SECONDS = 300;
        
        function createCardPlaceholders() {
            // Cria o Placeholder Global
            const globalContainer = document.getElementById('global-overview-container');
            globalContainer.innerHTML = `
                <div class="overview-card global-card" id="card-global" style="max-width: 100%;">
                    <div class="card-header" style="flex-wrap: wrap; gap: 10px;">
                        <h3><span class="material-symbols-rounded" style="font-size: 28px;">public</span> VISÃO GERAL DA REDE</h3>
                        <a href="equipamentos.html" class="card-header-button" title="Ver Distribuição por Fabricante" style="padding: 6px 16px; font-size: 0.95rem; gap: 8px; border: 1px solid rgba(255,255,255,0.2);">
                            <span class="material-symbols-rounded" style="font-size: 22px;">router</span> Ver Equipamentos
                        </a>
                    </div>
                    <div class="card-body">
                         <div class="card-stats">
                            <p>Calculando totais da rede...</p>
                        </div>
                    </div>
                </div>
            `;

            const grid = document.getElementById('overview-grid');
            grid.innerHTML = ''; // Limpa o grid antes de popular
            
            // Loop das OLTs normais primeiro
            oltsConfig.forEach(olt => {
                const pageUrl = olt.id.toLowerCase().replace('-', '') + '.html';
                grid.innerHTML += `
                    <div class="overview-card" id="card-${olt.id}">
                        <div class="card-header">
                            <h3><span class="material-symbols-rounded">dns</span> ${olt.id}</h3>
                            <a href="${pageUrl}" class="card-header-button" title="Ver Detalhes">
                                <span class="material-symbols-rounded" style="font-size: 20px;">manage_search</span>
                                <span class="material-symbols-rounded" style="font-size: 20px;">arrow_forward</span>
                            </a>
                        </div>
                        <div class="card-body">
                             <div class="card-stats">
                                <p>Carregando...</p>
                            </div>
                        </div>
                    </div>
                `;
            });

            // CARD DE MÓDULO EXCLUSIVO (Adicionado no final da grelha)
            grid.innerHTML += `
                <a href="equipamentos.html" class="overview-card" style="text-decoration: none; display: flex; flex-direction: column; border: 1px solid var(--m3-primary); background: linear-gradient(145deg, var(--m3-surface-container), var(--m3-surface-container-high));">
                    <div class="card-header" style="background-color: transparent; justify-content: center; border-bottom: 1px solid rgba(255,255,255,0.05); padding: 12px;">
                        <h3 style="color: var(--m3-on-surface); font-size: 1em; letter-spacing: 1px;"><span class="material-symbols-rounded" style="color: var(--m3-primary); font-size: 20px;">apps</span> MÓDULO GERENCIAL</h3>
                    </div>
                    <div class="card-body" style="flex-direction: column; justify-content: center; align-items: center; padding: 25px 15px;">
                        <span class="material-symbols-rounded" style="font-size: 50px; color: var(--m3-primary); margin-bottom: 10px; filter: drop-shadow(0 0 10px rgba(103,7,159,0.5));">router</span>
                        <strong style="font-size: 1.2rem; color: var(--m3-on-surface); text-align: center; margin-bottom: 5px;">Equipamentos</strong>
                        <span style="font-size: 0.85rem; color: var(--m3-on-surface-variant); text-align: center;">Ver Distribuição de Fabricantes</span>
                    </div>
                </a>
            `;
        }
        
        async function fetchOltData(olt) {
            const range = olt.type === 'nokia' ? `${olt.sheetTab}!A:E` : `${olt.sheetTab}!A:C`;
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${range}?key=${API_KEY}`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Falha ao buscar dados da aba ${olt.sheetTab}`);
                const data = await response.json();
                const rows = (data.values || []).slice(1);
                
                let totalOnline = 0;
                let totalOffline = 0;
                const portData = {};
                const localProblems = new Set(); 

                rows.forEach(columns => {
                    if (columns.length === 0) return;
                    
                    let placa, porta, isOnline;

                    if (olt.type === 'nokia') {
                        const status = columns[4] || '';
                        const pon = columns[0];
                        isOnline = status.trim().toLowerCase().includes('up');
                        if (pon) {
                            const parts = pon.split('/');
                            if (parts.length >= 4) { placa = parts[2]; porta = parts[3]; }
                        }
                    } else { 
                        const status = columns[2] || '';
                        const portStr = columns[0];
                        isOnline = status.trim().toLowerCase() === 'active';
                        if (portStr) {
                            if (olt.type === 'furukawa-10') {
                                const parts = portStr.split('/');
                                if (parts.length >= 2) { placa = parts[0]; porta = parts[1]; }
                            } else { 
                                const match = portStr.match(/GPON(\d+)\/(\d+)/);
                                if (match) { placa = match[1]; porta = match[2]; }
                            }
                        }
                    }

                    if (isOnline) totalOnline++; else totalOffline++;

                    if (placa && porta) {
                        const portKey = `${placa}/${porta}`;
                        if (!portData[portKey]) portData[portKey] = { off: 0, total: 0 };
                        portData[portKey].total++;
                        if (!isOnline) portData[portKey].off++;
                    }
                });

                // ==========================================
                // LÓGICA DE ALARMES V2 (HIERARQUIA E EXCEÇÕES)
                // ==========================================
                let isMicroSuper = false;
                let isCritical = false;     
                let isWarning = false;
                let ports100Down = 0;
                let hasBackbone = false;

                const isExceptionOlt = (olt.id === 'MGP' || olt.id === 'HEL-2');

                // 2. AVALIAÇÃO POR PORTA (MICRO)
                for (const key in portData) {
                    const { off, total } = portData[key];
                    if (total === 0) continue; 

                    const percOffline = off / total;

                    // Gatilho de Backbone (Porta 100% OFF)
                    if (percOffline === 1) {
                        ports100Down++;
                    }

                    if (isExceptionOlt) {
                        // Exceção MGP/HEL-2: Só alerta se porta bater 100%
                        if (percOffline === 1) {
                            isMicroSuper = true;
                        }
                    } else {
                        // OLTs Padrão
                        if (percOffline >= 0.5 && total >= 5) {
                            isMicroSuper = true;
                        } else if (off >= 32) {
                            isCritical = true; // Novo gatilho: 32+ clientes
                        } else if (off >= 16 && off < 32) {
                            isWarning = true;  // Mantém lógica antiga para Atenção
                        }
                    }
                }

                // 3. APLICAÇÃO DA HIERARQUIA DE SUPRESSÃO
                if (ports100Down >= 2) {
                    // Backbone Detectado: Gera a faixa no topo e ENGOLE os Toasts laterais da OLT
                    hasBackbone = true;
                } else if (isMicroSuper) {
                    localProblems.add(`[${olt.id}] STATUS::SUPER`);
                } else if (isCritical) {
                    localProblems.add(`[${olt.id}] STATUS::CRIT`);
                } else if (isWarning) {
                    localProblems.add(`[${olt.id}] STATUS::WARN`);
                }

                updateCardUI(olt.id, { onlineCount: totalOnline, offlineCount: totalOffline, type: olt.type });
                
                return { 
                    id: olt.id, 
                    problems: localProblems, 
                    onlineCount: totalOnline, 
                    offlineCount: totalOffline, 
                    type: olt.type,
                    hasBackbone: hasBackbone,
                    backboneDetails: hasBackbone ? `OLT: ${olt.id}` : null
                };

            } catch (error) {
                console.error(`Erro para OLT ${olt.id}:`, error);
                updateCardUI(olt.id, { error: true });
                return { id: olt.id, problems: new Set(), onlineCount: 0, offlineCount: 0, type: olt.type, hasBackbone: false };
            }
        }
        
        function updateCardUI(oltId, data) {
            const card = document.getElementById(`card-${oltId}`);
            if (!card) return;
            if (data.error) {
                card.querySelector('.card-stats').innerHTML = `<p>Erro ao carregar.</p>`;
                return;
            }
            const { onlineCount, offlineCount, type } = data;
            const total = onlineCount + offlineCount;
            const onlinePercent = total > 0 ? (onlineCount / total) * 100 : 0;
            const offlinePercent = 100 - onlinePercent;
            
            const header = card.querySelector('.card-header');
            header.classList.remove('status-normal', 'status-atencao', 'status-problema');
            
            if (offlinePercent > 10) { header.classList.add('status-problema'); }
            else if (offlinePercent > 5) { header.classList.add('status-atencao'); }
            else { header.classList.add('status-normal'); }
            
            const statsHtml = `
                <div class="stat-item">
                    <span class="stat-number">${total}</span>
                    <label><span class="material-symbols-rounded icon-total">router</span> Total</label>
                </div>
                <div class="stat-item online">
                    <span class="stat-number">${onlineCount}</span>
                    <label><span class="material-symbols-rounded icon-up">check_circle</span> ${type === 'nokia' ? 'Up' : 'Active'}</label>
                </div>
                <div class="stat-item offline">
                    <span class="stat-number">${offlineCount}</span>
                    <label><span class="material-symbols-rounded icon-down">error</span> ${type === 'nokia' ? 'Down' : 'Inactive'}</label>
                </div>
            `;
            
            const newRadius = 40; 
            const circumference = 2 * Math.PI * newRadius; 
            const offset = circumference - (onlinePercent / 100) * circumference;
            const chartHtml = `
                <div class="donut-chart-container">
                    <svg class="donut-chart" width="100" height="100" viewBox="0 0 100 100">
                        <circle class="donut-bg" cx="50" cy="50" r="${newRadius}"></circle>
                        <circle class="donut-fg" cx="50" cy="50" r="${newRadius}"
                            stroke-dasharray="${circumference}"
                            stroke-dashoffset="${offset}">
                        </circle>
                    </svg>
                    <div class="chart-text"><span class="stat-number">${Math.round(onlinePercent)}%</span></div>
                </div>
            `;

            card.querySelector('.card-body').innerHTML = `<div class="card-stats">${statsHtml}</div>${chartHtml}`;
        }

        function updateGlobalCardUI(globalOnline, globalOffline, nokiaOnline, nokiaTotal, furukawaOnline, furukawaTotal, top3Olts) {
            const card = document.getElementById('card-global');
            if (!card) return;
            
            const total = globalOnline + globalOffline;
            const onlinePercent = total > 0 ? (globalOnline / total) * 100 : 0;
            const offlinePercent = 100 - onlinePercent;
            
            const header = card.querySelector('.card-header');
            header.classList.remove('status-normal', 'status-atencao', 'status-problema');
            
            if (offlinePercent > 10) { header.classList.add('status-problema'); }
            else if (offlinePercent > 5) { header.classList.add('status-atencao'); }
            else { header.classList.add('status-normal'); }
            
            // Coluna 1: Totais (Esquerda)
            const statsHtml = `
                <div class="stat-item global-stat">
                    <span class="stat-number">${total}</span>
                    <label><span class="material-symbols-rounded icon-total">router</span> Total Geral</label>
                </div>
                <div class="stat-item online global-stat">
                    <span class="stat-number">${globalOnline}</span>
                    <label><span class="material-symbols-rounded icon-up">check_circle</span> Equipamentos Online</label>
                </div>
                <div class="stat-item offline global-stat">
                    <span class="stat-number">${globalOffline}</span>
                    <label><span class="material-symbols-rounded icon-down">error</span> Equipamentos Offline</label>
                </div>
            `;

            // Coluna 2: Fabricantes (Centro com Imagens)
            const nokiaPct = nokiaTotal > 0 ? (nokiaOnline / nokiaTotal) * 100 : 0;
            const furukawaPct = furukawaTotal > 0 ? (furukawaOnline / furukawaTotal) * 100 : 0;
            
            const vendorHtml = `
                <div style="display: flex; flex-direction: column; gap: 25px; width: 100%; max-width: 300px;">
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <img src="imagens/nokia.png" alt="Nokia" style="max-height: 28px; width: auto; object-fit: contain;">
                            <span class="stat-number" style="font-size: 1.4rem; width: auto;">${Math.round(nokiaPct)}%</span>
                        </div>
                        <div style="height: 14px; background: var(--m3-surface-container-high); border-radius: 7px; overflow: hidden;">
                            <div style="height: 100%; width: ${nokiaPct}%; background: var(--m3-color-success); border-radius: 7px;"></div>
                        </div>
                        <div style="font-size: 1rem; color: var(--m3-on-surface-variant); margin-top: 8px; text-align: right;">
                            <span class="stat-number" style="font-size: 1.1rem; width: auto;">${nokiaOnline}</span> / <span class="stat-number" style="font-size: 1.1rem; width: auto;">${nokiaTotal}</span> Online
                        </div>
                    </div>
                    
                    <div>
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <img src="imagens/furukawa.png" alt="Furukawa" style="max-height: 28px; width: auto; object-fit: contain;">
                            <span class="stat-number" style="font-size: 1.4rem; width: auto;">${Math.round(furukawaPct)}%</span>
                        </div>
                        <div style="height: 14px; background: var(--m3-surface-container-high); border-radius: 7px; overflow: hidden;">
                            <div style="height: 100%; width: ${furukawaPct}%; background: var(--m3-color-success); border-radius: 7px;"></div>
                        </div>
                        <div style="font-size: 1rem; color: var(--m3-on-surface-variant); margin-top: 8px; text-align: right;">
                            <span class="stat-number" style="font-size: 1.1rem; width: auto;">${furukawaOnline}</span> / <span class="stat-number" style="font-size: 1.1rem; width: auto;">${furukawaTotal}</span> Online
                        </div>
                    </div>
                </div>
            `;

            // Coluna 3: Ranking Top 3 (Direita)
            let rankingHtmlContent = '';
            const temOffline = top3Olts.some(olt => olt.offline > 0);
            
            if (temOffline) {
                top3Olts.forEach((olt, index) => {
                    if (olt.offline === 0) return;
                    
                    const offlinePct = olt.total > 0 ? (olt.offline / olt.total) * 100 : 0;
                    
                    rankingHtmlContent += `
                        <div style="margin-bottom: 18px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px; align-items: baseline;">
                                <strong style="color: var(--m3-on-surface); font-size: 1.2rem;">${index + 1}º ${olt.id}</strong>
                                <span class="stat-number" style="font-size: 1.3rem; color: var(--m3-color-error); width: auto;">${olt.offline} OFF</span>
                            </div>
                            <div style="height: 12px; background: var(--m3-surface-container-high); border-radius: 6px; overflow: hidden;">
                                <div style="height: 100%; width: ${offlinePct}%; background: var(--m3-color-error); border-radius: 6px;"></div>
                            </div>
                        </div>
                    `;
                });
            } else {
                rankingHtmlContent = `
                    <div style="text-align: center; color: var(--m3-color-success); font-weight: 700; font-size: 1.4rem; margin-top: 15px; display: flex; flex-direction: column; align-items: center; gap: 10px;">
                        <span class="material-symbols-rounded" style="font-size: 48px;">sentiment_very_satisfied</span>
                        Toda a Rede 100% Online!
                    </div>
                `;
            }

            const rankingHtml = `
                <div style="display: flex; flex-direction: column; width: 100%; max-width: 300px;">
                    ${rankingHtmlContent}
                </div>
            `;
            
            card.querySelector('.card-body').innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; width: 100%; flex-wrap: wrap; gap: 20px;">
                    <div class="card-stats" style="padding-right: 0; min-width: 200px;">${statsHtml}</div>
                    <div style="flex: 1; border-left: 1px solid var(--m3-outline); padding-left: 30px; display: flex; justify-content: center; min-width: 250px;">${vendorHtml}</div>
                    <div style="flex: 1; border-left: 1px solid var(--m3-outline); padding-left: 30px; display: flex; justify-content: center; min-width: 250px;">${rankingHtml}</div>
                </div>
            `;
        }

        async function runOverview() {
            const timestampEl = document.getElementById('update-timestamp');
            if (timestampEl) {
                if (timestampEl.textContent === "" || timestampEl.textContent === "Aguardando dados...") {
                    timestampEl.innerHTML = '<span class="material-symbols-rounded">hourglass_empty</span> Buscando dados...';
                }
            }
            
            if(document.getElementById('overview-grid').innerHTML.trim() === "") {
                createCardPlaceholders();
            }
            
            const promises = oltsConfig.map(olt => fetchOltData(olt));
            const results = await Promise.all(promises);
            
            const allProblems = new Set();
            let globalOnline = 0;
            let globalOffline = 0;
            
            let nokiaOnline = 0, nokiaTotal = 0;
            let furukawaOnline = 0, furukawaTotal = 0;
            
            let oltStatsList = [];
            let activeBackboneDetails = []; // Lista para armazenar alertas de Backbone ativos

            results.forEach(result => {
                // Adiciona problemas padrão (Toasts) ao Set
                result.problems.forEach(problem => allProblems.add(problem));
                
                globalOnline += result.onlineCount;
                globalOffline += result.offlineCount;
                
                let oltTotal = result.onlineCount + result.offlineCount;
                
                if (result.type === 'nokia') {
                    nokiaOnline += result.onlineCount;
                    nokiaTotal += oltTotal;
                } else {
                    furukawaOnline += result.onlineCount;
                    furukawaTotal += oltTotal;
                }

                oltStatsList.push({
                    id: result.id,
                    offline: result.offlineCount,
                    total: oltTotal
                });

                // Coleta alertas de Backbone, se houver
                if (result.hasBackbone) {
                    activeBackboneDetails.push(result.backboneDetails);
                }
            });

            oltStatsList.sort((a, b) => b.offline - a.offline);
            const top3Olts = oltStatsList.slice(0, 3);

            updateGlobalCardUI(globalOnline, globalOffline, nokiaOnline, nokiaTotal, furukawaOnline, furukawaTotal, top3Olts);

            // GESTÃO DO BANNER DE BACKBONE NA INTERFACE
            const backboneContainer = document.getElementById('backbone-alert-container');
            if (activeBackboneDetails.length > 0) {
                backboneContainer.innerHTML = `
                    <div class="backbone-alert">
                        <span class="material-symbols-rounded">sos</span>
                        <div class="backbone-text-container">
                            <p class="backbone-title">Rompimento de Backbone?!</p>
                            <p class="backbone-details">${activeBackboneDetails.join('<br>')}</p>
                        </div>
                    </div>
                `;
                backboneContainer.style.display = 'block';
            } else {
                backboneContainer.style.display = 'none';
                backboneContainer.innerHTML = '';
            }

            // GESTÃO DOS TOASTS LATERAIS
            if (typeof checkAndNotifyForNewProblems === 'function') {
                checkAndNotifyForNewProblems(allProblems);
            }
            
            const now = new Date();
            const dataHoje = now.toLocaleDateString('pt-BR');
            const horaAgora = now.toLocaleTimeString('pt-BR');
            
            if(timestampEl) {
                timestampEl.innerHTML = `
                    <span class="material-symbols-rounded">calendar_today</span> ${dataHoje}
                    <span style="width: 1px; height: 12px; background: rgba(255,255,255,0.3); margin: 0 5px;"></span>
                    <span class="material-symbols-rounded">schedule</span> ${horaAgora}
                `;
                
                timestampEl.classList.remove('updated-anim');
                void timestampEl.offsetWidth; 
                timestampEl.classList.add('updated-anim');
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            loadHeader({ title: "Painel de Monitoramento", exactTitle: true });
            loadFooter();
            runOverview();
            setInterval(runOverview, REFRESH_INTERVAL_SECONDS * 1000);
        });
    </script>
    
    <style>
        @media (max-width: 768px) {
            .global-stat {
                display: flex !important;
                flex-direction: column-reverse !important;
                align-items: flex-start !important;
                gap: 5px !important;
                margin-bottom: 12px;
            }
        }
    </style>

</body>
</html>