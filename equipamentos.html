<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parque de Equipamentos</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">    
    
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/png" href="favicon.png">
</head>
<body>

    <div id="toast-container"></div>

    <div class="page-container">
        <div id="header-placeholder"></div>

        <main class="main-content" style="flex-direction: column;">
            
            <div style="margin-bottom: 20px; padding: 10px 20px; background: rgba(0,0,0,0.2); border-radius: 8px; border-left: 4px solid var(--m3-primary);">
                <h2 style="margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 10px;">
                    <span class="material-symbols-rounded">category</span> Distribuição de Equipamentos por Fabricante
                </h2>
                <p style="margin: 5px 0 0 0; font-size: 0.9rem; color: var(--m3-on-surface-variant);">
                    Este painel agrupa todos os clientes da rede baseado no prefixo do Serial/MAC (ex: ALCL, FRKW, HWTC). 
                    <em style="color: var(--m3-color-warning);">(Modo de Simulação Ativo)</em>
                </p>
            </div>

            <div id="fabricantes-grid" class="grid-container" style="grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));">
                <p style="padding: 20px;">Carregando dados da rede e processando fabricantes...</p>
            </div>
            
        </main>
    </div>

    <div id="footer-placeholder"></div>

    <script src="layout.js"></script>
    <script src="notifications.js"></script>

    <script>
        const oltsConfig = [
            { id: 'HEL-1', sheetTab: 'HEL1', type: 'nokia' },
            { id: 'HEL-2', sheetTab: 'HEL2', type: 'nokia' },
            { id: 'PQA-1', sheetTab: 'PQA1', type: 'nokia' },
            { id: 'PSV-1', sheetTab: 'PSV1', type: 'nokia' },
            { id: 'MGP',   sheetTab: 'MGP',  type: 'nokia' },
            { id: 'LTXV-1', sheetTab: 'LTXV1', type: 'furukawa-10' }, 
            { id: 'LTXV-2', sheetTab: 'LTXV2', type: 'furukawa-2' },
            { id: 'PQA-2',  sheetTab: 'PQA2',  type: 'furukawa-2' },
            { id: 'PQA-3',  sheetTab: 'PQA3',  type: 'furukawa-2' },
            { id: 'SB-1',   sheetTab: 'SB1',   type: 'furukawa-2' },
            { id: 'SB-2',   sheetTab: 'SB2',   type: 'furukawa-2' },
            { id: 'SB-3',   sheetTab: 'SB3',   type: 'furukawa-2' },
            { id: 'PSV-7',  sheetTab: 'PSV7',  type: 'furukawa-2' },
            { id: 'SBO-1',  sheetTab: 'SBO1',  type: 'furukawa-10' },
            { id: 'SBO-2',  sheetTab: 'SBO2',  type: 'furukawa-2' },
            { id: 'SBO-3',  sheetTab: 'SBO3',  type: 'furukawa-2' },
            { id: 'SBO-4',  sheetTab: 'SBO4',  type: 'furukawa-2' },
        ];

        const API_KEY = 'AIzaSyA88uPhiRhU3JZwKYjA5B1rX7ndXpfka0I';
        const SHEET_ID = '1BDx0zd0UGzOr2qqg1nftfe5WLUMh6MkcFO5psAG5GtU';
        
        // Mapeamento fornecido
        const marcasList = [
            { nome: 'NOKIA', prefixos: 'ALCL, NBEL' },
            { nome: 'FURUKAWA', prefixos: 'FRKW' },
            { nome: 'ASKEY', prefixos: 'ASKY, INVP, TLCM' },
            { nome: 'EURONET', prefixos: 'CIOT, YHTC' },
            { nome: 'HUAWEI', prefixos: 'HWTC' },
            { nome: 'MITRASTAR', prefixos: 'MSTC' },
            { nome: 'MAXPRINT / V-SOL', prefixos: 'GPON, VSOL' },
            { nome: 'PARKS', prefixos: 'PRKS' },
            { nome: 'TENDA', prefixos: 'TDTC' },
            { nome: 'SHORELINE', prefixos: 'SHLN' }
        ];

        async function fetchOltTotals(olt) {
            const range = olt.type === 'nokia' ? `${olt.sheetTab}!A:E` : `${olt.sheetTab}!A:C`;
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${range}?key=${API_KEY}`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) return { id: olt.id, online: 0, offline: 0, type: olt.type };
                const data = await response.json();
                const rows = (data.values || []).slice(1);
                
                let online = 0, offline = 0;
                rows.forEach(columns => {
                    if (columns.length === 0) return;
                    let isOnline = false;
                    if (olt.type === 'nokia') {
                        isOnline = (columns[4] || '').trim().toLowerCase().includes('up');
                    } else { 
                        isOnline = (columns[2] || '').trim().toLowerCase() === 'active';
                    }
                    if (isOnline) online++; else offline++;
                });
                return { id: olt.id, online, offline, type: olt.type };
            } catch (error) {
                return { id: olt.id, online: 0, offline: 0, type: olt.type };
            }
        }

        async function renderFabricantesDashboard() {
            const grid = document.getElementById('fabricantes-grid');
            
            // 1. Busca os totais reais das OLTs
            const promises = oltsConfig.map(olt => fetchOltTotals(olt));
            const oltsData = await Promise.all(promises);

            // 2. Cria o objeto para armazenar os totais por fabricante
            const statsPorFabricante = {};
            marcasList.forEach(marca => {
                statsPorFabricante[marca.nome] = {
                    nome: marca.nome,
                    prefixos: marca.prefixos,
                    online: 0,
                    offline: 0,
                    olts: {} // Para guardar a quantidade por OLT
                };
            });

            // 3. SIMULAÇÃO: Distribui os equipamentos lidos das OLTs pelos fabricantes
            oltsData.forEach(olt => {
                if(olt.online === 0 && olt.offline === 0) return;

                // Lógica de distribuição baseada no tipo da OLT
                let distribuicao = [];
                if (olt.type === 'nokia') {
                    // OLT Nokia tem maioria Nokia, mas tem outros misturados
                    distribuicao = [
                        { marca: 'NOKIA', pct: 0.80 },
                        { marca: 'ASKEY', pct: 0.08 },
                        { marca: 'HUAWEI', pct: 0.05 },
                        { marca: 'EURONET', pct: 0.04 },
                        { marca: 'TENDA', pct: 0.03 }
                    ];
                } else {
                    // OLT Furukawa tem maioria Furukawa, mas tem V-SOL e Parks
                    distribuicao = [
                        { marca: 'FURUKAWA', pct: 0.70 },
                        { marca: 'MAXPRINT / V-SOL', pct: 0.15 },
                        { marca: 'PARKS', pct: 0.05 },
                        { marca: 'MITRASTAR', pct: 0.05 },
                        { marca: 'SHORELINE', pct: 0.05 }
                    ];
                }

                // Aplica as percentagens
                let onlineRestante = olt.online;
                let offlineRestante = olt.offline;

                distribuicao.forEach((dist, index) => {
                    let on = Math.floor(olt.online * dist.pct);
                    let off = Math.floor(olt.offline * dist.pct);
                    
                    // Garante que a última marca pega o resto para bater o total exato
                    if (index === distribuicao.length - 1) {
                        on = onlineRestante;
                        off = offlineRestante;
                    } else {
                        onlineRestante -= on;
                        offlineRestante -= off;
                    }

                    if (on > 0 || off > 0) {
                        statsPorFabricante[dist.marca].online += on;
                        statsPorFabricante[dist.marca].offline += off;
                        
                        if (!statsPorFabricante[dist.marca].olts[olt.id]) {
                            statsPorFabricante[dist.marca].olts[olt.id] = { online: 0, offline: 0 };
                        }
                        statsPorFabricante[dist.marca].olts[olt.id].online += on;
                        statsPorFabricante[dist.marca].olts[olt.id].offline += off;
                    }
                });
            });

            // 4. Converte em array e ordena por quem tem mais equipamentos
            const listaOrdenada = Object.values(statsPorFabricante)
                .filter(f => (f.online + f.offline) > 0) // Esconde quem tem 0
                .sort((a, b) => (b.online + b.offline) - (a.online + a.offline));

            // 5. Renderiza os Cards
            grid.innerHTML = '';
            
            listaOrdenada.forEach(fab => {
                const total = fab.online + fab.offline;
                const pctOnline = total > 0 ? (fab.online / total) * 100 : 0;
                const pctOffline = 100 - pctOnline;
                
                let headerClass = 'status-normal';
                if (pctOffline > 10) headerClass = 'status-problema';
                else if (pctOffline > 5) headerClass = 'status-atencao';

                const newRadius = 35; 
                const circumference = 2 * Math.PI * newRadius; 
                const offset = circumference - (pctOnline / 100) * circumference;

                // Tabela de distribuição por OLT (dentro do card)
                let oltsHtml = '';
                const oltsOrdenadas = Object.entries(fab.olts).sort((a,b) => (b[1].online + b[1].offline) - (a[1].online + a[1].offline));
                
                oltsOrdenadas.forEach(([oltId, stats]) => {
                    const totalOlt = stats.online + stats.offline;
                    oltsHtml += `
                        <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.85rem;">
                            <span style="color: var(--m3-on-surface); font-weight: 500;">${oltId}</span>
                            <span>
                                <span style="color: var(--m3-on-surface-variant);">${totalOlt}</span> 
                                <span style="font-size: 0.75rem; color: var(--m3-color-error); margin-left: 5px;">(${stats.offline} off)</span>
                            </span>
                        </div>
                    `;
                });

                grid.innerHTML += `
                    <div class="overview-card" style="display: flex; flex-direction: column;">
                        <div class="card-header ${headerClass}" style="flex-direction: column; align-items: flex-start; padding: 12px 15px;">
                            <h3 style="font-size: 1.2rem; margin-bottom: 2px;"><span class="material-symbols-rounded">dns</span> ${fab.nome}</h3>
                            <span style="font-size: 0.75rem; opacity: 0.8; font-family: var(--font-family-mono);">Prefixos: ${fab.prefixos}</span>
                        </div>
                        
                        <div class="card-body" style="flex-direction: column; align-items: stretch; padding: 15px;">
                            
                            <div style="display: flex; position: relative; padding-bottom: 15px; border-bottom: 1px solid var(--m3-outline);">
                                <div class="card-stats" style="padding-right: 90px;">
                                    <div class="stat-item" style="grid-template-columns: 50px 1fr; gap: 8px;">
                                        <span class="stat-number" style="font-size: 1.5rem;">${total}</span>
                                        <label style="font-size: 0.8rem;"><span class="material-symbols-rounded" style="font-size: 16px; width: 16px;">dns</span> Total</label>
                                    </div>
                                    <div class="stat-item online" style="grid-template-columns: 50px 1fr; gap: 8px;">
                                        <span class="stat-number" style="font-size: 1.5rem;">${fab.online}</span>
                                        <label style="font-size: 0.8rem;"><span class="material-symbols-rounded" style="font-size: 16px; width: 16px;">check_circle</span> Online</label>
                                    </div>
                                    <div class="stat-item offline" style="grid-template-columns: 50px 1fr; gap: 8px;">
                                        <span class="stat-number" style="font-size: 1.5rem;">${fab.offline}</span>
                                        <label style="font-size: 0.8rem;"><span class="material-symbols-rounded" style="font-size: 16px; width: 16px;">error</span> Offline</label>
                                    </div>
                                </div>
                                
                                <div class="donut-chart-container" style="width: 80px; height: 80px; right: 0;">
                                    <svg class="donut-chart" width="80" height="80" viewBox="0 0 100 100">
                                        <circle class="donut-bg" cx="50" cy="50" r="${newRadius}" stroke-width="12"></circle>
                                        <circle class="donut-fg" cx="50" cy="50" r="${newRadius}" stroke-width="12"
                                            stroke-dasharray="${circumference}" stroke-dashoffset="${offset}">
                                        </circle>
                                    </svg>
                                    <div class="chart-text"><span class="stat-number" style="font-size: 1rem;">${Math.round(pctOnline)}%</span></div>
                                </div>
                            </div>

                            <div style="margin-top: 10px;">
                                <div style="font-size: 0.75rem; text-transform: uppercase; color: var(--m3-on-surface-variant); font-weight: bold; margin-bottom: 5px; letter-spacing: 0.5px;">
                                    Distribuição na Rede
                                </div>
                                <div style="max-height: 100px; overflow-y: auto; padding-right: 5px;" class="custom-scroll">
                                    ${oltsHtml}
                                </div>
                            </div>

                        </div>
                    </div>
                `;
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadHeader({ title: "Parque de Equipamentos", exactTitle: true });
            loadFooter();
            renderFabricantesDashboard();
        });
    </script>

    <style>
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: var(--m3-outline); border-radius: 4px; }
    </style>
</body>
</html>