<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Parque de Equipamentos</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;700&family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">    
    
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/png" href="favicon.png">
</head>
<body>

    <div id="toast-container"></div>

    <div class="page-container">
        <div id="header-placeholder"></div>

        <main class="main-content" style="flex-direction: column;">
            
            <div style="margin-bottom: 20px; padding: 10px 20px; background: rgba(0,0,0,0.2); border-radius: 8px; border-left: 4px solid var(--m3-color-success);">
                <h2 style="margin: 0; font-size: 1.2rem; display: flex; align-items: center; gap: 10px;">
                    <span class="material-symbols-rounded">category</span> Distribuição de Equipamentos por Fabricante
                </h2>
                <p style="margin: 5px 0 0 0; font-size: 0.9rem; color: var(--m3-on-surface-variant);">
                    Este painel agrupa todos os clientes da rede baseado no prefixo (4 primeiros dígitos) do Serial/MAC encontrado nas planilhas.
                </p>
            </div>

            <div id="fabricantes-grid" class="grid-container" style="grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));">
                <p style="padding: 20px;">Carregando dados reais da rede e agrupando seriais...</p>
            </div>
            
        </main>
    </div>

    <div id="footer-placeholder"></div>

    <script src="layout.js"></script>
    <script src="notifications.js"></script>

    <script>
        const oltsConfig = [
            { id: 'HEL-1', sheetTab: 'HEL1', type: 'nokia' },
            { id: 'HEL-2', sheetTab: 'HEL2', type: 'nokia' },
            { id: 'PQA-1', sheetTab: 'PQA1', type: 'nokia' },
            { id: 'PSV-1', sheetTab: 'PSV1', type: 'nokia' },
            { id: 'MGP',   sheetTab: 'MGP',  type: 'nokia' },
            { id: 'LTXV-1', sheetTab: 'LTXV1', type: 'furukawa-10' }, 
            { id: 'LTXV-2', sheetTab: 'LTXV2', type: 'furukawa-2' },
            { id: 'PQA-2',  sheetTab: 'PQA2',  type: 'furukawa-2' },
            { id: 'PQA-3',  sheetTab: 'PQA3',  type: 'furukawa-2' },
            { id: 'SB-1',   sheetTab: 'SB1',   type: 'furukawa-2' },
            { id: 'SB-2',   sheetTab: 'SB2',   type: 'furukawa-2' },
            { id: 'SB-3',   sheetTab: 'SB3',   type: 'furukawa-2' },
            { id: 'PSV-7',  sheetTab: 'PSV7',  type: 'furukawa-2' },
            { id: 'SBO-1',  sheetTab: 'SBO1',  type: 'furukawa-10' },
            { id: 'SBO-2',  sheetTab: 'SBO2',  type: 'furukawa-2' },
            { id: 'SBO-3',  sheetTab: 'SBO3',  type: 'furukawa-2' },
            { id: 'SBO-4',  sheetTab: 'SBO4',  type: 'furukawa-2' },
        ];

        const API_KEY = 'AIzaSyA88uPhiRhU3JZwKYjA5B1rX7ndXpfka0I';
        const SHEET_ID = '1BDx0zd0UGzOr2qqg1nftfe5WLUMh6MkcFO5psAG5GtU';
        
        // Mapeamento de Fabricantes
        const marcasList = [
            { nome: 'NOKIA', prefixos: 'ALCL, NBEL' },
            { nome: 'FURUKAWA', prefixos: 'FRKW' },
            { nome: 'ASKEY', prefixos: 'ASKY, INVP, TLCM' },
            { nome: 'EURONET', prefixos: 'CIOT, YHTC' },
            { nome: 'HUAWEI', prefixos: 'HWTC' },
            { nome: 'MITRASTAR', prefixos: 'MSTC' },
            { nome: 'MAXPRINT / V-SOL', prefixos: 'GPON, VSOL' },
            { nome: 'PARKS', prefixos: 'PRKS' },
            { nome: 'TENDA', prefixos: 'TDTC' },
            { nome: 'SHORELINE', prefixos: 'SHLN' }
        ];

        // Cria um dicionário rápido para buscar a marca a partir do prefixo
        const prefixToMarca = {};
        marcasList.forEach(marca => {
            marca.prefixos.split(',').forEach(p => {
                prefixToMarca[p.trim().toUpperCase()] = marca.nome;
            });
        });

        async function fetchOltDataAndSerials(olt) {
            // Nokia precisa de Col C (index 2) para Serial e Col E (index 4) para Status (A:E)
            // Furukawa precisa de Col C (index 2) para Status e Col D (index 3) para Serial (A:D)
            const range = olt.type === 'nokia' ? `${olt.sheetTab}!A:E` : `${olt.sheetTab}!A:D`;
            const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${range}?key=${API_KEY}`;
            
            try {
                const response = await fetch(url);
                if (!response.ok) return { id: olt.id, prefixCounts: {} };
                const data = await response.json();
                const rows = (data.values || []).slice(1);
                
                const prefixCounts = {};

                rows.forEach(columns => {
                    if (columns.length === 0) return;
                    
                    let isOnline = false;
                    let serialRaw = '';

                    if (olt.type === 'nokia') {
                        isOnline = (columns[4] || '').trim().toLowerCase().includes('up');
                        serialRaw = (columns[2] || '').trim(); // Coluna C
                    } else { 
                        isOnline = (columns[2] || '').trim().toLowerCase() === 'active';
                        serialRaw = (columns[3] || '').trim(); // Coluna D
                    }

                    // Ignorar se não tiver serial
                    if (!serialRaw) return;

                    // Pega os 4 primeiros caracteres
                    const prefix = serialRaw.substring(0, 4).toUpperCase();
                    if (!prefix) return;

                    if (!prefixCounts[prefix]) {
                        prefixCounts[prefix] = { online: 0, offline: 0 };
                    }
                    
                    if (isOnline) prefixCounts[prefix].online++;
                    else prefixCounts[prefix].offline++;
                });

                return { id: olt.id, prefixCounts };
            } catch (error) {
                console.error(`Erro buscando seriais de ${olt.id}`, error);
                return { id: olt.id, prefixCounts: {} };
            }
        }

        async function renderFabricantesDashboard() {
            const timestampEl = document.getElementById('update-timestamp');
            if (timestampEl) {
                timestampEl.innerHTML = '<span class="material-symbols-rounded">hourglass_empty</span> Buscando dados...';
            }

            const grid = document.getElementById('fabricantes-grid');
            
            // 1. Busca os dados reais de todas as OLTs em paralelo
            const promises = oltsConfig.map(olt => fetchOltDataAndSerials(olt));
            const oltsData = await Promise.all(promises);

            // 2. Cria o objeto para armazenar os totais
            const statsPorFabricante = {};
            
            // Inicia todas as marcas conhecidas com 0
            marcasList.forEach(marca => {
                statsPorFabricante[marca.nome] = {
                    nome: marca.nome,
                    prefixos: marca.prefixos,
                    online: 0,
                    offline: 0,
                    olts: {} 
                };
            });

            // Cria a categoria OUTROS para seriais não reconhecidos
            statsPorFabricante['OUTROS / DESCONHECIDO'] = {
                nome: 'OUTROS / DESCONHECIDO',
                prefixos: 'Vários',
                online: 0,
                offline: 0,
                olts: {}
            };

            // 3. Processa os dados retornados de cada OLT
            oltsData.forEach(oltData => {
                if (!oltData.prefixCounts) return;

                Object.entries(oltData.prefixCounts).forEach(([prefix, counts]) => {
                    // Verifica de quem é esse prefixo, ou manda para OUTROS
                    const marcaNome = prefixToMarca[prefix] || 'OUTROS / DESCONHECIDO';
                    
                    // Atualiza totais gerais do fabricante
                    statsPorFabricante[marcaNome].online += counts.online;
                    statsPorFabricante[marcaNome].offline += counts.offline;

                    // Atualiza a distribuição por OLT
                    if (!statsPorFabricante[marcaNome].olts[oltData.id]) {
                        statsPorFabricante[marcaNome].olts[oltData.id] = { online: 0, offline: 0 };
                    }
                    statsPorFabricante[marcaNome].olts[oltData.id].online += counts.online;
                    statsPorFabricante[marcaNome].olts[oltData.id].offline += counts.offline;
                });
            });

            // 4. Converte em array e ordena (Quem tem mais equipamentos aparece primeiro)
            const listaOrdenada = Object.values(statsPorFabricante)
                .filter(f => (f.online + f.offline) > 0) // Esconde fabricantes com 0 equipamentos
                .sort((a, b) => (b.online + b.offline) - (a.online + a.offline));

            // 5. Renderiza os Cards
            grid.innerHTML = '';
            
            if (listaOrdenada.length === 0) {
                grid.innerHTML = '<p style="padding: 20px;">Nenhum equipamento com serial foi encontrado na rede.</p>';
            } else {
                listaOrdenada.forEach(fab => {
                    const total = fab.online + fab.offline;
                    const pctOnline = total > 0 ? (fab.online / total) * 100 : 0;
                    const pctOffline = 100 - pctOnline;
                    
                    let headerClass = 'status-normal';
                    if (pctOffline > 10) headerClass = 'status-problema';
                    else if (pctOffline > 5) headerClass = 'status-atencao';

                    const newRadius = 35; 
                    const circumference = 2 * Math.PI * newRadius; 
                    const offset = circumference - (pctOnline / 100) * circumference;

                    // Tabela de distribuição por OLT (dentro do card)
                    let oltsHtml = '';
                    const oltsOrdenadas = Object.entries(fab.olts).sort((a,b) => (b[1].online + b[1].offline) - (a[1].online + a[1].offline));
                    
                    oltsOrdenadas.forEach(([oltId, stats]) => {
                        const totalOlt = stats.online + stats.offline;
                        oltsHtml += `
                            <div style="display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.85rem;">
                                <span style="color: var(--m3-on-surface); font-weight: 500;">${oltId}</span>
                                <span>
                                    <span style="color: var(--m3-on-surface-variant);">${totalOlt}</span> 
                                    <span style="font-size: 0.75rem; color: var(--m3-color-error); margin-left: 5px;">(${stats.offline} off)</span>
                                </span>
                            </div>
                        `;
                    });

                    // Destaque visual caso seja a aba "OUTROS"
                    const alertIcon = fab.nome === 'OUTROS / DESCONHECIDO' ? '<span class="material-symbols-rounded" style="color: var(--m3-color-warning); font-size: 16px; margin-left: 5px;">warning</span>' : '';

                    grid.innerHTML += `
                        <div class="overview-card" style="display: flex; flex-direction: column;">
                            <div class="card-header ${headerClass}" style="flex-direction: column; align-items: flex-start; padding: 12px 15px;">
                                <h3 style="font-size: 1.2rem; margin-bottom: 2px; display: flex; align-items: center;"><span class="material-symbols-rounded" style="margin-right: 5px;">dns</span> ${fab.nome} ${alertIcon}</h3>
                                <span style="font-size: 0.75rem; opacity: 0.8; font-family: var(--font-family-mono);">Prefixos: ${fab.prefixos}</span>
                            </div>
                            
                            <div class="card-body" style="flex-direction: column; align-items: stretch; padding: 15px;">
                                
                                <div style="display: flex; position: relative; padding-bottom: 15px; border-bottom: 1px solid var(--m3-outline);">
                                    <div class="card-stats" style="padding-right: 90px;">
                                        <div class="stat-item" style="grid-template-columns: 50px 1fr; gap: 8px;">
                                            <span class="stat-number" style="font-size: 1.5rem;">${total}</span>
                                            <label style="font-size: 0.8rem;"><span class="material-symbols-rounded" style="font-size: 16px; width: 16px;">dns</span> Total</label>
                                        </div>
                                        <div class="stat-item online" style="grid-template-columns: 50px 1fr; gap: 8px;">
                                            <span class="stat-number" style="font-size: 1.5rem;">${fab.online}</span>
                                            <label style="font-size: 0.8rem;"><span class="material-symbols-rounded" style="font-size: 16px; width: 16px;">check_circle</span> Online</label>
                                        </div>
                                        <div class="stat-item offline" style="grid-template-columns: 50px 1fr; gap: 8px;">
                                            <span class="stat-number" style="font-size: 1.5rem;">${fab.offline}</span>
                                            <label style="font-size: 0.8rem;"><span class="material-symbols-rounded" style="font-size: 16px; width: 16px;">error</span> Offline</label>
                                        </div>
                                    </div>
                                    
                                    <div class="donut-chart-container" style="width: 80px; height: 80px; right: 0;">
                                        <svg class="donut-chart" width="80" height="80" viewBox="0 0 100 100">
                                            <circle class="donut-bg" cx="50" cy="50" r="${newRadius}" stroke-width="12"></circle>
                                            <circle class="donut-fg" cx="50" cy="50" r="${newRadius}" stroke-width="12"
                                                stroke-dasharray="${circumference}" stroke-dashoffset="${offset}">
                                            </circle>
                                        </svg>
                                        <div class="chart-text"><span class="stat-number" style="font-size: 1rem;">${Math.round(pctOnline)}%</span></div>
                                    </div>
                                </div>

                                <div style="margin-top: 10px;">
                                    <div style="font-size: 0.75rem; text-transform: uppercase; color: var(--m3-on-surface-variant); font-weight: bold; margin-bottom: 5px; letter-spacing: 0.5px;">
                                        Distribuição na Rede
                                    </div>
                                    <div style="max-height: 100px; overflow-y: auto; padding-right: 5px;" class="custom-scroll">
                                        ${oltsHtml}
                                    </div>
                                </div>

                            </div>
                        </div>
                    `;
                });
            }

            // --- ATUALIZAÇÃO DO TIMESTAMP ---
            const now = new Date();
            const dataHoje = now.toLocaleDateString('pt-BR');
            const horaAgora = now.toLocaleTimeString('pt-BR');
            
            if (timestampEl) {
                timestampEl.innerHTML = `
                    <span class="material-symbols-rounded">calendar_today</span> ${dataHoje}
                    <span style="width: 1px; height: 12px; background: rgba(255,255,255,0.3); margin: 0 5px;"></span>
                    <span class="material-symbols-rounded">schedule</span> ${horaAgora}
                `;
                
                timestampEl.classList.remove('updated-anim');
                void timestampEl.offsetWidth; 
                timestampEl.classList.add('updated-anim');
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadHeader({ title: "Parque de Equipamentos", exactTitle: true });
            loadFooter();
            renderFabricantesDashboard();
        });
    </script>

    <style>
        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background: var(--m3-outline); border-radius: 4px; }
    </style>
</body>
</html>